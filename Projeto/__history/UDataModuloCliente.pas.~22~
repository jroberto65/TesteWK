unit UDataModuloCliente;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, uClienteModel;

type
  TDataModuleCliente = class(TDataModule)
    fdQryCliente: TFDQuery;
    fdQryPesquisaCliente: TFDQuery;
    fdQryInserirCliente: TFDQuery;
    fdQryAlterarCliente: TFDQuery;
    fdQryExcluirCliente: TFDQuery;
    fdQryPesquisaClienteCodigo: TFDAutoIncField;
    fdQryPesquisaClienteNome: TStringField;
    fdQryPesquisaClienteCidade: TStringField;
    fdQryPesquisaClienteUF: TStringField;
    fdTransaction: TFDTransaction;
  private
    { Private declarations }
  public
    { Public declarations }
    procedure pesquisarCliente(pNome: string);
    procedure CarregarCliente(pCliente: TCliente; pCodigoCliente: Integer);
    function GerarCodigo: Integer;
    function InserirCliente(pCliente: TCliente; out pErro: string): Boolean;
    function AlterarCliente(pCliente: TCliente; out pErro: string): Boolean;
    function ExcluirCliente(pCodigoCliente: Integer; out pErro: string): Boolean;
  end;

var
  DataModuleCliente: TDataModuleCliente;

implementation

uses UDataModulo;

{%CLASSGROUP 'Vcl.Controls.TControl'}

{$R *.dfm}

{ TDataModuleCliente }

function TDataModuleCliente.AlterarCliente(pCliente: TCliente;
  out pErro: string): Boolean;
begin
  Result := True;
  with fdQryAlterarCliente, pCliente do
  begin
    ParamByName('Codigo').Value := Codigo;
    ParamByName('Nome').Value := Nome;
    ParamByName('Cidade').Value := Cidade;
    ParamByName('UF').Value := UF;
    try
      Transaction.StartTransaction;
      ExecSQL();
    except on E: Exception do
      begin
        Transaction.Rollback;
        pErro := 'Erro ao tentar alterar o cliente: ' + sLineBreak +  e.Message;
        Result := False;
      end;
    end;
  end;
end;

procedure TDataModuleCliente.CarregarCliente(pCliente: TCliente;
  pCodigoCliente: Integer);
var
  sqlCliente : TFDQuery;
begin
  sqlCliente := TFDQuery.Create(nil);
  try
    with sqlCliente do
    begin
      Connection := DataModulo.fdConexao;
      SQL.Text := 'select * from clientes where codigo = ' + IntToStr(pCodigoCliente);
      Open;
      with pCliente do
      begin
        Codigo := FieldByName('Codigo').Value;
        Nome := FieldByName('Nome').Value;
        Cidade := FieldByName('Cidade').Value;
        UF := FieldByName('UF').Value;
     end;
    end;
  finally
    FreeAndNil(sqlCliente);
  end;
end;

function TDataModuleCliente.ExcluirCliente(pCodigoCliente: Integer;
  out pErro: string): Boolean;
begin
  with fdQryExcluirCliente do
  begin
    params[0].Value := pCodigoCliente;
    try
      Transaction.StartTransaction;
      ExecSQL;
      Result := True
    except on E: Exception do
      begin
        Transaction.Rollback;
        pErro := 'Erro ao tentar excluir o cliente: ' + sLineBreak +  e.Message;
        Result := False;
      end;
    end;
  end;
end;

function TDataModuleCliente.GerarCodigo: Integer;
var
  sqlSequencia : TFDQuery;
begin
  sqlSequencia := TFDQuery.Create(nil);
  try
    with sqlSequencia do
    begin
      Connection := DataModulo.fdConexao;
      SQL.Text := 'select coalesce(max(codigo), 0) + 1 as seq from clientes';
      Open;
      Result := FieldByName('seq').AsInteger;
      Close;
    end;
  finally
    FreeAndNil(sqlSequencia);
  end;
end;

function TDataModuleCliente.InserirCliente(pCliente: TCliente;
  out pErro: string): Boolean;
begin
  with fdQryInserirCliente, pCliente do
  begin
    Params[0].Value := 0;
    Params[1].Value := Nome;
    Params[2].Value := Cidade;
    Params[3].Value := UF;
    try
      Transaction.StartTransaction;
      ExecSQL();
      Result := True
    except on E: Exception do
      begin
        Transaction.Rollback;
        pErro := 'Erro ao tentar inserir o cliente: ' + sLineBreak +  e.Message;
        Result := False;
      end;
    end;
  end;
end;

procedure TDataModuleCliente.pesquisarCliente(pNome: string);
begin
  if fdQryPesquisaCliente.Active then
    fdQryPesquisaCliente.Close;
  fdQryPesquisaCliente.ParamByName('Nome').AsString := ('%'+pNome+'%');
  fdQryPesquisaCliente.Open;
  fdQryPesquisaCliente.First;
end;

end.
